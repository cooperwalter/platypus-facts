# Implementation Plan -- Daily Platypus Facts

## Status Summary

**1 spec enhancement pending implementation.** Core service is complete and fully functional. Brevo is the production email provider. MAX_SUBSCRIBERS defaults to 200.

- **410 tests passing** across 19 test files with **869 expect() calls**
- **Type check clean**, **lint clean**
- **No TODOs, FIXMEs, skipped tests, or placeholder code** in source
- **28 real platypus facts** sourced and seeded with AI-generated illustrations (31 images in `public/images/facts/`)
- **Platypus mascot PNG** optimized to 74KB at 400Ã—400 (down from 451KB at 1024Ã—1024)
- **Fact images** optimized to 640Ã—640 (86KBâ€“538KB, down from 243KBâ€“1.3MB)
- **Latest tag**: 0.0.63

---

## Pending Enhancements (Priority Order)

### P6: Favicon (`specs/favicon.md`) â€” LOW PRIORITY
Replace inline SVG emoji favicon with mascot-based favicons.

Current state: All 10 render functions in `src/routes/pages.ts` use an inline SVG data URI with a duck emoji (ğŸ¦†) as the favicon (rendered in each function's `<head>`). Favicon files already generated by P7's optimization script: `public/favicon.ico`, `public/favicon-32.png`, `public/apple-touch-icon.png`.

- [x] Generate `public/favicon.ico` (16Ã—16 + 32Ã—32 multi-resolution ICO) from `public/platypus.png` â€” done by P7
- [x] Generate `public/favicon-32.png` (32Ã—32 PNG) from `public/platypus.png` â€” done by P7
- [x] Generate `public/apple-touch-icon.png` (180Ã—180 PNG) from `public/platypus.png` â€” done by P7
- [ ] Update all 10 `render*()` functions in `src/routes/pages.ts` to replace inline SVG emoji favicon with:
  - `<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">`
  - `<link rel="icon" type="image/x-icon" href="/favicon.ico">`
  - `<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">`
- [ ] Update tests if any assert on favicon HTML (check routes.test.ts)

The 10 render functions producing full HTML documents:
1. `renderSignupPage`
2. `renderFactPage`
3. `renderMessagePage` â€” also covers `renderConfirmationPage` which uses it
4. `renderUnsubscribePage`
5. `render404Page`
6. `renderInspirationPage`
7. `renderAboutPage`
8. `renderDevMessageList`
9. `renderDevEmailDetail`
10. `renderHealthDashboard`

---

## Implementation Dependencies

```
P2 (Email Mascot) âœ… COMPLETE
P1 (Welcome Email) âœ… COMPLETE
P4 (Static Cache Headers) âœ… COMPLETE
P3 (Health Dashboard) âœ… COMPLETE
P5 (Micro-Interactions) âœ… COMPLETE
P7 (Image Optimization) âœ… COMPLETE â”€â”€â†’ P6 (Favicon)    [favicon files already generated by P7]
```

**Recommended implementation order:** P6 next

---

## Previously Completed (Core Service)

All core spec items are complete:

| Area | Status | Notes |
|------|--------|-------|
| Platypus mascot image | âœ… Complete | `public/platypus.png` generated, displayed as hero image on home page |
| Footer text | âœ… Complete | "Made with â¤ï¸ by Cooper Walter" matches spec |
| Web page emoji removal | âœ… Complete | All occurrences of ğŸ¦«ğŸ¦†ğŸ¥š removed from web pages |
| Email mascot branding (P2) | âœ… Complete | Mascot image replaces ğŸ¦«ğŸ¦†ğŸ¥š in all email templates, `emailWrapper()` accepts `baseUrl`, `AlreadySubscribedEmailData` interface added |
| Welcome email (P1) | âœ… Complete | `renderConfirmationPage()` async, sends welcome email with most recent fact on confirmation, `WelcomeEmailData`/`welcomeEmailHtml`/`welcomeEmailPlain` added, `getMostRecentSentFact()` query, List-Unsubscribe headers, failure-safe (27 new tests) |
| Static cache headers (P4) | âœ… Complete | `getCacheControl()` helper, images 7-day immutable, CSS 1-day, others 1-hour, Content-Type preserved (14 new tests) |
| Health dashboard (P3) | âœ… Complete | `/health?detail=true` JSON API, `/health/dashboard` HTML page, `getSubscriberCounts`/`getFactStats`/`getLastSend`/`getDatabaseSizeBytes` queries, `formatUptime` helper, uptime tracking via closure, `databasePath` in deps (19 new tests) |
| Micro-interactions (P5) | âœ… Complete | All transitions wrapped in `@media (prefers-reduced-motion: no-preference)`, link/button/input/mascot/card transitions, fadeIn animation, focus-visible glow, `:active` scale-down, hover-only card shadow |
| Image optimization (P7) | âœ… Complete | `src/scripts/optimize-images.ts` script with `sharp`/`png-to-ico`, mascot 74KB@400Ã—400, fact images 86â€“538KB@640Ã—640, favicon generation (ICO+PNG+apple-touch-icon), idempotent, `optimize-images` npm script |
| Email provider (Brevo) | âœ… Complete | Brevo wired in, sender name included, Postmark removed |
| Subscription flow | âœ… Complete | Cap checked at signup + confirmation, List-Unsubscribe headers on all 3 email types |
| Email templates | âœ… Complete | Daily fact, confirmation, already-subscribed â€” correct subjects, plain-text fallbacks, source links, fact page link |
| Fact cycling | âœ… Complete | New facts prioritized, re-randomized per cycle, 14 tests |
| Daily send | âœ… Complete | Idempotent, --force dev-only, graceful failure, race condition handling, 14 tests |
| Sync + images | âœ… Complete | Upsert by text, DALL-E image generation, auth failure handling |
| Drizzle schema | âœ… Complete | All 5 tables match spec exactly |
| Signup page | âœ… Complete | Warm note, fan count, form, capacity handling, mascot image |
| Fact page | âœ… Complete | Illustration, sources, branding, signup link |
| /inspiration page | âœ… Complete | Life is Strange: Double Exposure origin story |
| /about page | âœ… Complete | Project description, tech stack, Brevo mention |
| MAX_SUBSCRIBERS default | âœ… Complete | Default 200, matches spec |
| DAILY_SEND_TIME_UTC default | âœ… Complete | Default 13:00, matches spec |
| Confirmation page | âœ… Complete | All states handled, cap check |
| Unsubscribe pages | âœ… Complete | GET confirmation + POST processing |
| Health endpoint | âœ… Complete | GET /health returns `{ status: "ok" }` |
| Dev message viewer | âœ… Complete | /dev/messages list + detail |
| Rate limiting | âœ… Complete | 5 per IP per hour on subscribe |
| Infrastructure/deploy | âœ… Complete | Brevo in deploy config, GitHub Actions, Dockerfile |
| Background pattern | âœ… Complete | SVG repeat with low opacity |
| Desktop top padding | âœ… Complete | 6rem padding on â‰¥768px |
| CRON_SETUP.md | âœ… Complete | Cron documentation exists |
| Dockerfile | âœ… Complete | Multi-stage, oven/bun, arm64 handled by CI |
| Life is Strange attribution | âœ… Complete | README, signup page |
| ARCHITECTURE.md diagram | âœ… Complete | Up-to-date |
| Fact sources | âœ… Complete | All 28 facts have sources in data/facts.json |
| Responsive design | âœ… Complete | Mobile breakpoints implemented |
| .dockerignore | âœ… Complete | Exists |
| CI/CD pipeline | âœ… Complete | GitHub Actions workflow |

---

## Outstanding Items (Non-Blocking, Not Spec-Required)

- **Drizzle query builder adoption**: Only `src/lib/db.ts` uses raw `sqlite` (for low-level migration/PRAGMA logic that must run before Drizzle). All query modules already use Drizzle query builder. No further migration needed.
- **Manual Brevo testing**: Test with real Brevo API before production launch
- **Database backup strategy**: Post-launch, not spec-required
